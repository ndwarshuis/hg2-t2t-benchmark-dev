from pathlib import Path

conf = {
    "hg2_07": {
        "asm_url": "https://s3-us-west-2.amazonaws.com/human-pangenomics/T2T/scratch/HG002/assemblies/drafts/assembly.v0.7.fasta",
        "chrom_maps": {
            h: {
                **{f"chr{i}": f"chr{i}_{H}" for i in [*range(1, 23)]},
                **{"chrX": "chrX_MATERNAL", "chrY": "chrY_PATERNAL"},
            }
            for h, H in [("pat", "PATERNAL"), ("mat", "MATERNAL")]
        },
    },
    "hg2_09": {
        "asm_url": "https://s3-us-west-2.amazonaws.com/human-pangenomics/T2T/HG002/assemblies/hg002v0.9.fasta",
        "chrom_maps": {
            h: {
                **{f"chr{i}": f"chr{i}_{H}" for i in [*range(1, 23)]},
                **{"chrX": "chrX_MATERNAL", "chrY": "chrY_PATERNAL"},
            }
            for h, H in [("pat", "PATERNAL"), ("mat", "MATERNAL")]
        },
    },
}

GAIRR_DIR = Path("resources/tools/gAIRR")
GENE_PATH = GAIRR_DIR / "example/material/{gene}_alleles_parsed.fasta"
GENES = [
    "TCRV",
    "TCRJ",
    "BCRV",
    "BCRJ",
    "TCRD_plusHep",
    "BCRD_plusHep",
]


wildcard_constraints:
    gene=f"({'|'.join(GENES)})",


# rule clone_gAIRR:
#     output:
#         directory(GAIRR_DIR),
#     shell:
#         """
#         git clone https://github.com/maojanlin/gAIRRsuite.git {output} && \
#         cd {output} && \
#         git checkout 72df9130ea87d6216b2ca76856ea6b8f8c81a29f
#         """


rule download_allele:
    output:
        "resources/alleles/{gene}.fa",
    shell:
        """
        curl -sSqL --fail \
        https://raw.githubusercontent.com/maojanlin/gAIRRsuite/72df9130ea87d6216b2ca76856ea6b8f8c81a29f/example/material/{wildcards.gene}_alleles_parsed.fasta \
        > {output}
        """


# rule gAIRR_genes:
#     input:
#         GAIRR_DIR,
#     output:
#         expand(GENE_PATH, gene=GENES),


rule build_chroms_mapper:
    output:
        "resources/{ref}/chrom_mapper_{hap}.txt",
    params:
        stream=lambda w: "\n".join(
            f"{k},{v}" for k, v in conf[w.ref]["chrom_maps"][w.hap].items()
        ),
    shell:
        """
        echo -e '{params.stream}' > {output}
        """


rule download_asm:
    output:
        "resources/refs/{ref}.fa",
    params:
        url=lambda w: conf[w.ref]["asm_url"],
    shell:
        """
        curl -qSs --fail -L {params.url} > {output}
        """


rule download_chm13:
    output:
        "resources/chm13.fa",
    params:
        url="https://s3-us-west-2.amazonaws.com/human-pangenomics/T2T/CHM13/assemblies/analysis_set/chm13v2.0.fa.gz",
    shell:
        """
        curl -qSs --fail -L {params.url} | gunzip -c > {output}
        """


use rule download_chm13 as download_chm_gff with:
    output:
        "resources/chm13.gff",
    params:
        url="https://ftp.ncbi.nlm.nih.gov/genomes/refseq/vertebrate_mammalian/Homo_sapiens/all_assembly_versions/GCF_009914755.1_T2T-CHM13v2.0/GCF_009914755.1_T2T-CHM13v2.0_genomic.gff.gz",


rule filter_asm_haps:
    input:
        rules.download_asm.output,
    output:
        "results/refs/{ref}_{hap}.fa",
    params:
        chroms=lambda w: " ".join(list(conf[w.ref]["chrom_maps"][w.hap].values())),
    conda:
        "envs/master.yml"
    shell:
        """
        samtools faidx {input} {params.chroms} > {output}
        """


rule bwa_index_haps:
    input:
        rules.filter_asm_haps.output,
    output:
        rules.filter_asm_haps.output[0] + ".bwt",
    conda:
        "envs/gairr.yml"
    shell:
        """
        bwa index -b 500000000 {input}
        """


GENE_ALIGN_PATH = Path("results/vdj_mapping/{ref}")


rule align_vdj_haps:
    input:
        # dummy, not used
        _index=rules.bwa_index_haps.output,
        asm=rules.filter_asm_haps.output,
        gene=rules.download_allele.output,
    output:
        GENE_ALIGN_PATH / "{gene}_{hap}.sam",
    params:
        flags=lambda w: "-a -T 10" if "plusHep" in w.gene else "-a",
    conda:
        "envs/gairr.yml"
    threads: 16
    shell:
        """
        bwa mem -t {threads} {params.flags} {input.asm} {input.gene} > {output}
        """


rule alignments_to_bed:
    input:
        rules.align_vdj_haps.output,
    output:
        GENE_ALIGN_PATH / "{gene}_{hap}.bed",
    conda:
        "envs/gairr.yml"
    shell:
        """
        cat {input} | sam2bed > {output}
        """


rule sort_alignments:
    input:
        rules.align_vdj_haps.output,
    output:
        GENE_ALIGN_PATH / "{gene}_{hap}.bam",
    conda:
        "envs/master.yml"
    shell:
        """
        samtools sort {input} > {output}
        """


rule merge_gene_alignments:
    input:
        expand(rules.sort_alignments.output, allow_missing=True, gene=GENES),
    output:
        GENE_ALIGN_PATH / "all_genes_{hap}.bam",
    conda:
        "envs/gairr.yml"
    shell:
        """
        samtools merge {input} > {output}
        """


rule index_gene_alignments:
    input:
        rules.merge_gene_alignments.output,
    output:
        rules.merge_gene_alignments.output[0] + ".bai",
    conda:
        "envs/master.yml"
    shell:
        """
        samtools index {input}
        """


rule merge_gene_beds:
    input:
        expand(rules.alignments_to_bed.output, allow_missing=True, gene=GENES),
    output:
        GENE_ALIGN_PATH / "all_genes_{hap}.bed",
    conda:
        "envs/gairr.yml"
    shell:
        """
        cat {input} | \
        sort -k1,1 -k2,2n -k3,3n | \
        cut -f1,2,3,4,5,14,16 | \
        mergeBed -i stdin -c 4,5,7 -o collapse,collapse,collapse \
        > {output}
        """


rule process_gene_beds:
    input:
        rules.merge_gene_beds.output,
    output:
        GENE_ALIGN_PATH / "final_genes_{hap}.bed",
    conda:
        "envs/master.yml"
    script:
        "scripts/process_genes.R"


rule filter_vdj_genes:
    input:
        rules.download_chm_gff.output,
    output:
        "results/chm13_immuno.gff",
    shell:
        """
        grep -E 'ID=gene-(IG(H|K|L|D)|TR(A|B|G|D))' {input} | \
        sed 's/^NC_060946.1/chr22/' | \
        sed 's/^NC_060938.1/chr14/' | \
        sed 's/^NC_060931.1/chr7/' | \
        sed 's/^NC_060926.1/chr2/' | \
        grep '^chr' | \
        grep -E 'immunoglobulin|T cell receptor' | \
        grep -vE 'RNA|polypeptide' > \
        {output} 
        """


rule lift_vdj_genes:
    input:
        chroms=rules.build_chroms_mapper.output,
        asm_ref=rules.filter_asm_haps.output,
        chm13_ref=rules.download_chm13.output,
        genes=rules.filter_vdj_genes.output,
    output:
        mapped="results/liftoff/{ref}/mapped_{hap}.gff",
        unmapped="results/liftoff/{ref}/unmapped_{hap}.txt",
        intermediate=directory("results/liftoff/{ref}/intermediate_{hap}"),
    log:
        "results/liftoff/{ref}/lift_{hap}.log",
    conda:
        "envs/master.yml"
    shell:
        """
        liftoff -f static/features.txt \
        -chroms {input.chroms} \
        -g {input.genes} \
        -o {output.mapped} \
        -u {output.unmapped} \
        -dir {output.intermediate} \
        {input.asm_ref} {input.chm13_ref} > {log} 2>&1
        """


rule process_lifted_genes:
    input:
        **{
            f"mapped_{h}": expand(
                rules.lift_vdj_genes.output.mapped, allow_missing=True, hap=h
            )
            for h in ["pat", "mat"]
        },
        **{
            f"unmapped_{h}": expand(
                rules.lift_vdj_genes.output.unmapped, allow_missing=True, hap=h
            )
            for h in ["pat", "mat"]
        },
        order="static/gene_order.tsv",
    output:
        loci="results/processed/{ref}_locus.tsv",
        genes="results/processed/{ref}_genes.tsv",
    conda:
        "envs/master.yml"
    script:
        "scripts/process_liftover.R"


rule make_wizzy_plots:
    input:
        loci=rules.process_lifted_genes.output.loci,
        genes=rules.process_lifted_genes.output.genes,
    output:
        unmapped="results/plots/{ref}/unmapped.pdf",
        mapped="results/plots/{ref}/mapped.pdf",
    conda:
        "envs/master.yml"
    script:
        "scripts/plot.R"


rule all:
    input:
        expand(rules.make_wizzy_plots.output, ref=list(conf)),
        expand(
            rules.process_gene_beds.output,
            ref=list(conf),
            hap=["mat", "pat"],
        ),
